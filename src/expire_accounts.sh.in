#! /bin/sh
#
#	bbs100 3.3 expire_accounts.sh	WJ99
#

DAYS=100		# expire accounts not used in 100 days

cd @prefix@

TEST=@TEST@
AWK=@AWK@

# PATH=/bin:/usr/bin

PROG=`basename $0`
echo "bbs100 ${PROG} by Walter de Jong <walter@heiho.net> (C) 2002"

DEFAULT_PARAM=etc/param

PARAM=${DEFAULT_PARAM}
if ${TEST} x"$1" != x ;
then
	PARAM=$1
fi

if ${TEST} ! -f "${PARAM}" ;
then
	echo "${PROG}: can't find param file ${PARAM}"
	exit 1
fi
if ${TEST} ! -r "${PARAM}" ;
then
	echo "${PROG}: the param file ${PARAM} should be readable"
	exit 1
fi

BASEDIR=`${AWK} '/basedir/ { print $2 }' ${PARAM}`
USERDIR=`${AWK} '/userdir/ { print $2 }' ${PARAM}`
TRASHDIR=`${AWK} '/trashdir/ { print $2 }' ${PARAM}`

cd ${BASEDIR}

if ${TEST} "$1" = "-h" -o "$1" = "--help" ;
then
	echo "usage: ${PROG} [param file]"
	echo "Expires accounts that have not been used for ${DAYS} days by moving them"
	echo "to the ${TRASHDIR} directory"
	exit 1
fi

cat <<EOF >/tmp/expire.$$
#! /bin/sh
#
#	bbs100 expire	WJ99
#
#	THIS IS A TEMPORARY EXECUTABLE
#	DO NOT EDIT THIS FILE   (changes will be lost)
#	DO NOT REMOVE THIS FILE (unless expire_accounts is not running)

PATH=/bin:/usr/bin

if ${TEST} -z "\$1" ;
then
	exit 0
fi

USER=\`echo "\$1" | cut -d / -f 3\`

echo "expiring \${USER}"

DIR=\`echo "\${USER}" | cut -b 1\`

rm -rf "${TRASHDIR}/users/\${DIR}/\${USER}"
mv "${USERDIR}/\${DIR}/\${USER}" "${TRASHDIR}/users/\${DIR}/\${USER}"

# EOB
EOF
chmod 700 /tmp/expire.$$
find ${USERDIR} -name 'UserData' -mtime +${DAYS} -depth -exec /tmp/expire.$$ {} \;
rm -f /tmp/expire.$$

# EOB
